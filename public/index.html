<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowOps360 Command Center</title>
<style>:root{--bg:#0f172a;--bg-card:#1e293b;--bg-hover:#334155;--text:#f1f5f9;--text-muted:#94a3b8;--text-dim:#64748b;--accent:#3b82f6;--accent-hover:#2563eb;--success:#22c55e;--warning:#f59e0b;--error:#ef4444;--border:#334155;--radius:8px;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;}.login-box{background:var(--bg-card);padding:2rem;border-radius:8px;border:1px solid var(--border);width:360px;}.login-box h1{font-size:1.25rem;margin-bottom:0.25rem;}.login-box p{color:var(--text-muted);font-size:0.85rem;margin-bottom:1.5rem;}.login-box label{display:block;font-size:0.8rem;color:var(--text-muted);margin-bottom:0.25rem;}.login-box input{width:100%;padding:0.5rem 0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem;margin-bottom:1rem;}.login-box input:focus{outline:none;border-color:var(--accent);}.login-box button{width:100%;padding:0.6rem;background:var(--accent);color:white;border:none;border-radius:8px;font-size:0.9rem;cursor:pointer;}.login-box button:hover{background:var(--accent-hover);}.login-box button:disabled{opacity:0.5;cursor:not-allowed;}.login-error{color:var(--error);font-size:0.8rem;margin-bottom:0.75rem;display:none;}#dashboard{display:none;}.top-bar{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1.5rem;background:var(--bg-card);border-bottom:1px solid var(--border);}.top-bar h1{font-size:1rem;}.top-bar-right{display:flex;align-items:center;gap:1rem;}.top-bar-right span{font-size:0.8rem;color:var(--text-muted);}.btn-sm{padding:0.35rem 0.75rem;font-size:0.8rem;border:1px solid var(--border);background:transparent;color:var(--text-muted);border-radius:8px;cursor:pointer;}.btn-sm:hover{background:var(--bg-hover);color:var(--text);}.nav-tabs{display:flex;gap:0;padding:0 1.5rem;background:var(--bg-card);border-bottom:1px solid var(--border);overflow-x:auto;}.nav-tab{padding:0.6rem 1.25rem;font-size:0.85rem;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.15s;}.nav-tab:hover{color:var(--text);background:var(--bg-hover);}.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:1rem;padding:1.5rem;}.card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;overflow:hidden;}.card-header{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-bottom:1px solid var(--border);}.card-header h3{font-size:0.85rem;font-weight:600;}.card-header .card-count{font-size:0.75rem;color:var(--text-muted);background:var(--bg);padding:0.15rem 0.5rem;border-radius:10px;}.card-body{padding:1rem;min-height:80px;position:relative;}.shimmer{background:linear-gradient(90deg,var(--bg) 25%,var(--bg-hover) 50%,var(--bg) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px;height:14px;margin-bottom:0.5rem;}@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}.card-empty{text-align:center;color:var(--text-dim);padding:1.5rem;font-size:0.85rem;}.card-error{text-align:center;padding:1rem;}.card-error p{color:var(--error);font-size:0.85rem;margin-bottom:0.75rem;}.btn-retry{padding:0.35rem 1rem;background:transparent;border:1px solid var(--error);color:var(--error);border-radius:8px;cursor:pointer;font-size:0.8rem;}.btn-retry:hover{background:var(--error);color:white;}.data-table{width:100%;border-collapse:collapse;font-size:0.8rem;}.data-table th{text-align:left;padding:0.5rem 0.75rem;color:var(--text-muted);font-weight:500;border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;user-select:none;}.data-table th:hover{color:var(--text);}.data-table th .sort-icon{margin-left:4px;opacity:0.4;}.data-table th.sorted .sort-icon{opacity:1;}.data-table td{padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);vertical-align:top;}.data-table tr:hover td{background:var(--bg-hover);}.badge{display:inline-block;padding:0.1rem 0.5rem;border-radius:10px;font-size:0.7rem;font-weight:500;}.badge-success{background:rgba(34,197,94,0.15);color:var(--success);}.badge-warning{background:rgba(245,158,11,0.15);color:var(--warning);}.badge-error{background:rgba(239,68,68,0.15);color:var(--error);}.badge-info{background:rgba(59,130,246,0.15);color:var(--accent);}.badge-muted{background:rgba(148,163,184,0.1);color:var(--text-muted);}.kpi-row{display:flex;gap:1rem;flex-wrap:wrap;}.kpi-metric{flex:1;min-width:100px;text-align:center;padding:0.5rem;}.kpi-value{font-size:1.5rem;font-weight:700;}.kpi-label{font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem;}.filter-bar{display:flex;gap:0.5rem;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;}.filter-bar input,.filter-bar select{padding:0.35rem 0.6rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.8rem;}.toggle-wrap{display:flex;align-items:center;gap:0.35rem;font-size:0.8rem;color:var(--text-muted);}.toggle-wrap input[type=checkbox]{accent-color:var(--accent);}.pagination{display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;font-size:0.8rem;color:var(--text-muted);}.pagination button{padding:0.25rem 0.6rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;font-size:0.8rem;}.pagination button:disabled{opacity:0.3;cursor:not-allowed;}.sub-tabs{display:flex;gap:0;padding:0 1.5rem;background:var(--bg);border-bottom:1px solid var(--border);}.sub-tab{padding:0.5rem 1rem;font-size:0.8rem;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;}.sub-tab:hover{color:var(--text-muted);}.sub-tab.active{color:var(--accent);border-bottom-color:var(--accent);}.sub-content{padding:1.5rem;}.toast{position:fixed;bottom:1.5rem;right:1.5rem;padding:0.75rem 1.25rem;border-radius:8px;font-size:0.85rem;z-index:1000;}.toast-success{background:var(--success);color:white;}.toast-error{background:var(--error);color:white;}.truncate{max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.placeholder-pillar{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;color:var(--text-dim);}.placeholder-pillar h2{font-size:1.25rem;margin-bottom:0.5rem;}.placeholder-pillar p{font-size:0.85rem;}</style>
</head>
<body>
<div id="login-screen">
<div class="login-box">
<h1>FlowOps360 Command Center</h1>
<p>COO Brain Dashboard</p>
<div id="login-error" class="login-error"></div>
<label for="email">Email</label>
<input type="email" id="email" placeholder="you@example.com" autocomplete="email">
<label for="password">Password</label>
<input type="password" id="password" placeholder="Password" autocomplete="current-password">
<button id="login-btn" onclick="doLogin()">Sign In</button>
</div>
</div>
<div id="dashboard">
<div class="top-bar">
<h1>FlowOps360 Command Center</h1>
<div class="top-bar-right">
<span id="user-email"></span>
<button class="btn-sm" onclick="doLogout()">Sign Out</button>
</div>
</div>
<div class="nav-tabs" id="nav-tabs"></div>
<div id="pillar-content"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
function showToast(message, type = 'success') {
const el = document.createElement('div');el.className = 'toast toast-' + type;el.textContent = message;document.body.appendChild(el);setTimeout(() => el.remove(), 3000);
}
function createCard(containerId, title, count) {
const card = document.createElement('div');card.className = 'card';card.id = 'card-' + containerId;const hdr = document.createElement('div');hdr.className = 'card-header';hdr.innerHTML = '<h3>' + escapeHtml(title) + '<\/h3>' + (count != null ? '<span class="card-count">' + count + '<\/span>' : '');const body = document.createElement('div');body.className = 'card-body';body.id = containerId;card.appendChild(hdr);card.appendChild(body);return card;
}
function cardLoading(containerId) {
const el = document.getElementById(containerId);if (!el) return;el.innerHTML = '<div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><div class="shimmer" style="width:70%"><\/div>';
}
function cardSuccess(containerId, html) {
const el = document.getElementById(containerId);if (!el) return;el.innerHTML = html;
}
function cardEmpty(containerId, message) {
const el = document.getElementById(containerId);if (!el) return;el.innerHTML = '<div class="card-empty">' + escapeHtml(message || 'No data') + '<\/div>';
}
function cardError(containerId, message, retryFn) {
const el = document.getElementById(containerId);if (!el) return;el.innerHTML = '<div class="card-error"><p>' + escapeHtml(message) + '<\/p>' +
(retryFn ? '<button class="btn-retry" onclick="' + retryFn + '()">Retry<\/button>' : '') + '<\/div>';
}
function updateCardCount(containerId, count) {
const card = document.getElementById('card-' + containerId);if (!card) return;const badge = card.querySelector('.card-count');if (badge) badge.textContent = count;
}
function escapeHtml(str) {
if (str == null) return '';return String(str).replace(/&/g,'&amp;').replace(/\x3c/g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function formatDate(d) {
if (!d) return '—';const dt = new Date(d);if (isNaN(dt)) return '—';return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function formatTime(d) {
if (!d) return '—';const dt = new Date(d);if (isNaN(dt)) return '—';return dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Phoenix' });
}
function formatCurrency(n) {
if (n == null) return '—';return '$' + Number(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
function daysAgo(d) {
if (!d) return null;const diff = Math.floor((Date.now() - new Date(d).getTime()) / 86400000);return diff;
}
function staleBadge(days) {
if (days == null) return '';if (days > 90) return '<span class="badge badge-error">' + days + 'd<\/span>';if (days > 30) return '<span class="badge badge-warning">' + days + 'd<\/span>';if (days > 14) return '<span class="badge badge-info">' + days + 'd<\/span>';return '<span class="badge badge-muted">' + days + 'd<\/span>';
}
function statusBadge(status) {
const map = {
now: 'badge-error', in_review: 'badge-warning', next: 'badge-info',
new: 'badge-muted', waiting: 'badge-warning', in_queue: 'badge-info',
pending: 'badge-warning', healthy: 'badge-success', critical: 'badge-error',
stale: 'badge-warning', warning: 'badge-warning',
};const cls = map[status] || 'badge-muted';return '<span class="badge ' + cls + '">' + escapeHtml(status || '—') + '<\/span>';
}
function clientBadge(name) {
if (!name) return '<span class="badge badge-muted">Unknown<\/span>';return '<span class="badge badge-info">' + escapeHtml(name) + '<\/span>';
}
function linkIcon(url) {
if (!url) return '';return '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">&#8599;<\/a>';
}
function renderSortableTable(containerId, columns, rows, opts) {
opts = opts || {};const pageSize = opts.pageSize || 25;let currentPage = 0;let sortCol = opts.defaultSort || null;let sortDir = opts.defaultSortDir || 'asc';let filterText = '';function render() {
let filtered = rows;if (filterText) {
const q = filterText.toLowerCase();filtered = rows.filter(r => columns.some(c => String(r[c.key] || '').toLowerCase().includes(q)));
}
if (sortCol) {
filtered = [...filtered].sort((a, b) => {
let va = a[sortCol], vb = b[sortCol];if (va == null) va = '';if (vb == null) vb = '';if (typeof va === 'number' && typeof vb === 'number') return sortDir === 'asc' ? va - vb : vb - va;return sortDir === 'asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
});
}
const total = filtered.length;const pages = Math.ceil(total / pageSize) || 1;if (currentPage >= pages) currentPage = pages - 1;const start = currentPage * pageSize;const pageRows = filtered.slice(start, start + pageSize);let html = '';if (rows.length > 10) {
html += '<div class="filter-bar"><input type="text" placeholder="Search..." value="' + escapeHtml(filterText) + '" onkeyup="window._tblFilter_' + containerId + '(this.value)"><\/div>';
}
html += '<table class="data-table"><thead><tr>';columns.forEach(c => {
const isSorted = sortCol === c.key;const arrow = isSorted ? (sortDir === 'asc' ? ' ▲' : ' ▼') : ' ▴';html += '<th class="' + (isSorted ? 'sorted' : '') + '" onclick="window._tblSort_' + containerId + '('' + c.key + '')">' + escapeHtml(c.label) + '<span class="sort-icon">' + arrow + '<\/span><\/th>';
});html += '<\/tr><\/thead><tbody>';if (pageRows.length === 0) {
html += '<tr><td colspan="' + columns.length + '" style="text-align:center;color:var(--text-dim);padding:1rem">No results<\/td><\/tr>';
} else {
pageRows.forEach(r => {
html += '<tr>';columns.forEach(c => {
const val = c.render ? c.render(r) : escapeHtml(r[c.key]);html += '<td>' + val + '<\/td>';
});html += '<\/tr>';
});
}
html += '<\/tbody><\/table>';if (total > pageSize) {
html += '<div class="pagination"><span>' + (start + 1) + '-' + Math.min(start + pageSize, total) + ' of ' + total + '<\/span><div>';html += '<button ' + (currentPage === 0 ? 'disabled' : '') + ' onclick="window._tblPage_' + containerId + '(' + (currentPage - 1) + ')">Prev<\/button> ';html += '<button ' + (currentPage >= pages - 1 ? 'disabled' : '') + ' onclick="window._tblPage_' + containerId + '(' + (currentPage + 1) + ')">Next<\/button>';html += '<\/div><\/div>';
}
cardSuccess(containerId, html);
}
window['_tblSort_' + containerId] = function(col) {
if (sortCol === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';else { sortCol = col; sortDir = 'asc'; }
render();
};window['_tblFilter_' + containerId] = function(val) { filterText = val; currentPage = 0; render(); };window['_tblPage_' + containerId] = function(p) { currentPage = p; render(); };render();
}

</script>
<script>
const SUPABASE_URL = 'https://bbsldtgusmjpulohxzpa.supabase.co';const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJic2xkdGd1c21qcHVsb2h4enBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTAyNzQsImV4cCI6MjA4NTYyNjI3NH0.wnRJpsDrXn2dRqQQsGVzToAeauxZgboPiXPxRc-5Xq8';const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);let failedLogins = 0;const PILLARS = [
{ id: 'operations', label: 'Operations', loader: loadOperations },
{ id: 'sales', label: 'Sales', loader: null },
{ id: 'marketing', label: 'Marketing', loader: null },
{ id: 'leadership', label: 'Leadership', loader: null },
{ id: 'finance', label: 'Finance', loader: null },
{ id: 'legal', label: 'Legal', loader: null },
{ id: 'system', label: 'System', loader: loadSystem },
];let activePillar = 'operations';async function doLogin() {
const email = document.getElementById('email').value.trim();const pw = document.getElementById('password').value;const errEl = document.getElementById('login-error');const btn = document.getElementById('login-btn');errEl.style.display = 'none';if (!email || !pw) { errEl.textContent = 'Email and password required.'; errEl.style.display = 'block'; return; }
btn.disabled = true; btn.textContent = 'Signing in...';try {
const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });if (error) {
failedLogins++;if (error.message && error.message.includes('Invalid login credentials')) {
errEl.textContent = 'Invalid email or password.';
} else if (failedLogins >= 3) {
errEl.textContent = 'Authentication may not be configured. Contact admin.';
} else {
errEl.textContent = error.message || 'Login failed.';
}
errEl.style.display = 'block';btn.disabled = false; btn.textContent = 'Sign In';return;
}
showDashboard(data.user);
} catch (e) {
errEl.textContent = 'Unable to connect. Check your network.';errEl.style.display = 'block';btn.disabled = false; btn.textContent = 'Sign In';
}
}
async function doLogout() {
await sb.auth.signOut();document.getElementById('dashboard').style.display = 'none';document.getElementById('login-screen').style.display = 'flex';document.getElementById('password').value = '';document.getElementById('login-error').style.display = 'none';
}
function showDashboard(user) {
document.getElementById('login-screen').style.display = 'none';document.getElementById('dashboard').style.display = 'block';document.getElementById('user-email').textContent = user.email;renderNav();navigateTo('operations');
}
function renderNav() {
const nav = document.getElementById('nav-tabs');nav.innerHTML = '';
PILLARS.forEach(p => {
const tab = document.createElement('div');tab.className = 'nav-tab' + (p.id === activePillar ? ' active' : '');tab.textContent = p.label;tab.onclick = () => navigateTo(p.id);nav.appendChild(tab);
});
}
function navigateTo(pillarId) {
activePillar = pillarId;renderNav();const content = document.getElementById('pillar-content');content.innerHTML = '';const pillar = PILLARS.find(p => p.id === pillarId);if (pillar && pillar.loader) {
pillar.loader(content);
} else {
content.innerHTML = '<div class="placeholder-pillar"><h2>' + escapeHtml(pillar.label) + '<\/h2><p>Coming in Phase 2<\/p><\/div>';
}
}
function logError(cardId, rpcName, code, message) {
console.error({ card_id: cardId, rpc_name: rpcName, error_code: code, error_message: message, timestamp: new Date().toISOString() });
}
async function handleCardError(containerId, rpcName, error, retryFn) {
if (error && (error.code === 'PGRST301' || error.message && error.message.includes('JWT'))) {
showToast('Session expired. Redirecting to login...', 'error');await doLogout();return;
}
logError(containerId, rpcName, error?.code || 'UNKNOWN', error?.message || 'Unknown error');cardError(containerId, error?.message || 'Failed to load data', retryFn);
}
(async function initApp() {
const { data: { session } } = await sb.auth.getSession();if (session && session.user) {
showDashboard(session.user);
}
sb.auth.onAuthStateChange((event) => {
if (event === 'SIGNED_OUT') {
document.getElementById('dashboard').style.display = 'none';document.getElementById('login-screen').style.display = 'flex';
}
});
})();

</script>
<script>
function loadOperations(container) {
const grid = document.createElement('div');grid.className = 'card-grid';const cards = [
{ id: 'now-items', title: 'Now Items', loader: loadNowItems },
{ id: 'todays-calendar', title: "Today's Calendar", loader: loadTodaysCalendar },
{ id: 'overdue-tickets', title: 'Overdue Tickets', loader: loadOverdueTickets },
{ id: 'retainer-billing', title: 'Retainer Billing', loader: loadRetainerBilling },
{ id: 'email-triage', title: 'Email Triage', loader: loadEmailTriage },
{ id: 'carry-forward', title: 'Carry Forward', loader: loadCarryForward },
{ id: 'stale-waiting', title: 'Stale / Waiting', loader: loadStaleWaiting },
{ id: 'open-tickets', title: 'Open Tickets', loader: loadOpenTickets },
{ id: 'time-entry', title: 'Time Entry', loader: loadTimeEntry },
];cards.forEach(c => {
grid.appendChild(createCard(c.id, c.title));c.loader();
});container.appendChild(grid);
}
async function loadNowItems() {
cardLoading('now-items');try {
const { data, error } = await sb.rpc('get_standup_now_items');if (error) { await handleCardError('now-items', 'get_standup_now_items', error, 'loadNowItems'); return; }
const items = data || [];if (items.length === 0) { cardEmpty('now-items', 'No active now items'); return; }
updateCardCount('now-items', items.length);let html = '<table class="data-table"><thead><tr><th>Task<\/th><th>Client<\/th><th>Due<\/th><th><\/th><\/tr><\/thead><tbody>';items.forEach(i => {
html += '<tr><td>' + escapeHtml(i.title) + '<\/td><td>' + clientBadge(i.client_name) + '<\/td><td>' + formatDate(i.due_date) + '<\/td><td>' + linkIcon(i.hubspot_ticket_url) + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';cardSuccess('now-items', html);
} catch (e) { await handleCardError('now-items', 'get_standup_now_items', e, 'loadNowItems'); }
}
async function loadTodaysCalendar() {
cardLoading('todays-calendar');try {
const { data, error } = await sb.rpc('get_standup_todays_calendar');if (error) { await handleCardError('todays-calendar', 'get_standup_todays_calendar', error, 'loadTodaysCalendar'); return; }
const items = data || [];if (items.length === 0) { cardEmpty('todays-calendar', 'No meetings today'); return; }
updateCardCount('todays-calendar', items.length);let html = '<table class="data-table"><thead><tr><th>Time<\/th><th>Meeting<\/th><th>Client<\/th><\/tr><\/thead><tbody>';items.forEach(i => {
html += '<tr><td style="white-space:nowrap">' + formatTime(i.start_time) + '<\/td><td>' + escapeHtml(i.subject) + '<\/td><td>' + clientBadge(i.client_name) + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';cardSuccess('todays-calendar', html);
} catch (e) { await handleCardError('todays-calendar', 'get_standup_todays_calendar', e, 'loadTodaysCalendar'); }
}
async function loadOverdueTickets() {
cardLoading('overdue-tickets');try {
const { data, error } = await sb.rpc('get_standup_overdue_tickets');if (error) { await handleCardError('overdue-tickets', 'get_standup_overdue_tickets', error, 'loadOverdueTickets'); return; }
if (!data || !data.by_client || data.by_client.length === 0) { cardEmpty('overdue-tickets', 'No overdue tickets'); return; }
updateCardCount('overdue-tickets', data.total_overdue + ' overdue / ' + data.total_open + ' open');let html = '<div class="kpi-row"><div class="kpi-metric"><div class="kpi-value" style="color:var(--error)">' + data.total_overdue + '<\/div><div class="kpi-label">Overdue<\/div><\/div><div class="kpi-metric"><div class="kpi-value">' + data.total_open + '<\/div><div class="kpi-label">Total Open<\/div><\/div><\/div>';html += '<table class="data-table" style="margin-top:0.75rem"><thead><tr><th>Client<\/th><th>Count<\/th><th>Sample Ticket<\/th><th><\/th><\/tr><\/thead><tbody>';data.by_client.forEach(c => {
const t = c.tickets && c.tickets[0];html += '<tr><td>' + clientBadge(c.client_name) + '<\/td><td>' + (c.count || c.tickets?.length || 0) + '<\/td><td class="truncate">' + escapeHtml(t?.subject || '—') + '<\/td><td>' + linkIcon(t?.hubspot_ticket_url) + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';cardSuccess('overdue-tickets', html);
} catch (e) { await handleCardError('overdue-tickets', 'get_standup_overdue_tickets', e, 'loadOverdueTickets'); }
}
async function loadRetainerBilling() {
cardLoading('retainer-billing');try {
const { data, error } = await sb.rpc('get_standup_retainer_billing');if (error) { await handleCardError('retainer-billing', 'get_standup_retainer_billing', error, 'loadRetainerBilling'); return; }
if (!data || !data.billing || data.billing.length === 0) { cardEmpty('retainer-billing', 'No retainer data'); return; }
let html = '<table class="data-table"><thead><tr><th>Client<\/th><th>Amount<\/th><th>Status<\/th><th>Planned<\/th><th>Done<\/th><\/tr><\/thead><tbody>';data.billing.forEach(b => {
const cap = data.capped_status && data.capped_status.find(c => c.client_name === b.client_name);let statusHtml = statusBadge(b.invoice_status);if (cap) { statusHtml += ' <span class="badge badge-warning">' + cap.hours_used + '/' + cap.included_hours_per_month + 'h<\/span>'; }
html += '<tr><td>' + clientBadge(b.client_name) + '<\/td><td>' + formatCurrency(b.retainer_amount) + '<\/td><td>' + statusHtml + '<\/td><td>' + (b.total_items_planned || 0) + '<\/td><td>' + (b.total_items_completed || 0) + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';cardSuccess('retainer-billing', html);
} catch (e) { await handleCardError('retainer-billing', 'get_standup_retainer_billing', e, 'loadRetainerBilling'); }
}
async function loadEmailTriage() {
cardLoading('email-triage');try {
const { data, error } = await sb.rpc('get_standup_email_digest');if (error) { await handleCardError('email-triage', 'get_standup_email_digest', error, 'loadEmailTriage'); return; }
if (!data || !data.stats) { cardEmpty('email-triage', 'No email data'); return; }
const s = data.stats;let html = '<div class="kpi-row">';html += '<div class="kpi-metric"><div class="kpi-value">' + (s.total_processed || 0) + '<\/div><div class="kpi-label">Processed<\/div><\/div>';html += '<div class="kpi-metric"><div class="kpi-value">' + (s.auto_filed || 0) + '<\/div><div class="kpi-label">Auto-Filed<\/div><\/div>';html += '<div class="kpi-metric"><div class="kpi-value" style="color:' + (s.needs_action > 0 ? 'var(--warning)' : 'var(--success)') + '">' + (s.needs_action || 0) + '<\/div><div class="kpi-label">Needs Action<\/div><\/div>';html += '<div class="kpi-metric"><div class="kpi-value">' + (data.unprocessed || 0) + '<\/div><div class="kpi-label">Unprocessed<\/div><\/div>';html += '<\/div>';if (data.standup_queue && data.standup_queue.length > 0) {
html += '<table class="data-table" style="margin-top:0.75rem"><thead><tr><th>Subject<\/th><th>From<\/th><th>Type<\/th><\/tr><\/thead><tbody>';data.standup_queue.forEach(e => {
html += '<tr><td>' + escapeHtml(e.subject) + '<\/td><td>' + escapeHtml(e.sender_email || e.from) + '<\/td><td>' + statusBadge(e.email_type || e.type) + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';
}
cardSuccess('email-triage', html);
} catch (e) { await handleCardError('email-triage', 'get_standup_email_digest', e, 'loadEmailTriage'); }
}
async function loadCarryForward() {
cardLoading('carry-forward');try {
const { data, error } = await sb.rpc('get_standup_carry_forward');if (error) { await handleCardError('carry-forward', 'get_standup_carry_forward', error, 'loadCarryForward'); return; }
const items = data || [];if (items.length === 0) { cardEmpty('carry-forward', 'Nothing carried forward'); return; }
updateCardCount('carry-forward', items.length);let html = '<table class="data-table"><thead><tr><th>Item<\/th><th>Type<\/th><th>Priority<\/th><\/tr><\/thead><tbody>';items.forEach(i => {
html += '<tr><td>' + escapeHtml(i.title || i.detail) + '<\/td><td>' + statusBadge(i.note_type || i.type) + '<\/td><td>' + statusBadge(i.priority) + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';cardSuccess('carry-forward', html);
} catch (e) { await handleCardError('carry-forward', 'get_standup_carry_forward', e, 'loadCarryForward'); }
}
async function loadStaleWaiting() {
cardLoading('stale-waiting');try {
const { data, error } = await sb.rpc('get_standup_stale_waiting');if (error) { await handleCardError('stale-waiting', 'get_standup_stale_waiting', error, 'loadStaleWaiting'); return; }
const items = data || [];if (items.length === 0) { cardEmpty('stale-waiting', 'Nothing stale or waiting'); return; }
updateCardCount('stale-waiting', items.length);let html = '<table class="data-table"><thead><tr><th>Item<\/th><th>Status<\/th><th>Age<\/th><\/tr><\/thead><tbody>';items.forEach(i => {
html += '<tr><td>' + escapeHtml(i.title || i.subject) + '<\/td><td>' + statusBadge(i.status || i.stage) + '<\/td><td>' + staleBadge(i.days_stale || daysAgo(i.last_modified)) + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';cardSuccess('stale-waiting', html);
} catch (e) { await handleCardError('stale-waiting', 'get_standup_stale_waiting', e, 'loadStaleWaiting'); }
}
async function loadOpenTickets() {
cardLoading('open-tickets');try {
const { data, error } = await sb.rpc('get_standup_open_tickets');if (error) { await handleCardError('open-tickets', 'get_standup_open_tickets', error, 'loadOpenTickets'); return; }
if (!data || !data.tickets) { cardEmpty('open-tickets', 'No open tickets'); return; }
const tickets = data.tickets;updateCardCount('open-tickets', data.total);let warn = '';const displayTickets = tickets.length > 500 ? (warn = '<div class="warning-banner">Showing first 500 of ' + tickets.length + ' tickets<\/div>', tickets.slice(0, 500)) : tickets;const columns = [
{ key: 'subject', label: 'Subject', render: r => '<span class="truncate" style="display:inline-block">' + escapeHtml(r.subject) + '<\/span> ' + linkIcon(r.url) },
{ key: 'client_name', label: 'Client', render: r => clientBadge(r.client_name) },
{ key: 'stage', label: 'Stage', render: r => statusBadge(r.stage) },
{ key: 'last_modified', label: 'Last Modified', render: r => formatDate(r.last_modified) },
];const el = document.getElementById('open-tickets');if (warn) el.innerHTML = warn;renderSortableTable('open-tickets', columns, displayTickets, { defaultSort: 'last_modified', defaultSortDir: 'desc' });
} catch (e) { await handleCardError('open-tickets', 'get_standup_open_tickets', e, 'loadOpenTickets'); }
}
async function loadTimeEntry(){cardEmpty('time-entry','Time entry coming in next deploy');}

</script>
<script>
function loadSystem(container) {
const subNav = document.createElement('div');subNav.className = 'sub-tabs';const tabs = [
{ id: 'sys-cron', label: 'Cron Jobs', loader: loadCronJobs },
{ id: 'sys-http', label: 'HTTP Log', loader: loadHttpLog },
{ id: 'sys-agents', label: 'Agent Registry', loader: loadAgentRegistry },
{ id: 'sys-brains', label: 'Brains', loader: null },
{ id: 'sys-config', label: 'Configuration', loader: null },
];const contentDiv = document.createElement('div');contentDiv.className = 'sub-content';contentDiv.id = 'sys-content';let activeSubTab = 'sys-cron';function renderSubTabs() {
subNav.innerHTML = '';tabs.forEach(t => {
const tab = document.createElement('div');tab.className = 'sub-tab' + (t.id === activeSubTab ? ' active' : '');tab.textContent = t.label;tab.onclick = () => {
activeSubTab = t.id;renderSubTabs();contentDiv.innerHTML = '';if (t.loader) t.loader(contentDiv);else contentDiv.innerHTML = '<div class="placeholder-pillar"><h2>' + escapeHtml(t.label) + '<\/h2><p>Coming in Phase 2<\/p><\/div>';
};subNav.appendChild(tab);
});
}
renderSubTabs();container.appendChild(subNav);container.appendChild(contentDiv);loadCronJobs(contentDiv);
}
async function loadCronJobs(container) {
container.innerHTML = '<div style="padding:1rem"><div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><\/div>';try {
const { data, error } = await sb.rpc('get_cron_job_status');if (error) throw error;const jobs = data || [];let showActiveOnly = true;function render() {
const filtered = showActiveOnly ? jobs.filter(j => j.active) : jobs;let html = '<div class="filter-bar"><label class="toggle-wrap"><input type="checkbox" ' + (showActiveOnly ? 'checked' : '') + ' onchange="window._cronToggle(this.checked)"> Active only<\/label><\/div>';html += '<table class="data-table"><thead><tr><th>Job Name<\/th><th>Schedule<\/th><th>Active<\/th><\/tr><\/thead><tbody>';if (filtered.length === 0) {
html += '<tr><td colspan="3" style="text-align:center;color:var(--text-dim)">No jobs<\/td><\/tr>';
} else {
filtered.forEach(j => {
html += '<tr><td>' + escapeHtml(j.jobname) + '<\/td><td><code style="font-size:0.75rem;color:var(--text-muted)">' + escapeHtml(j.schedule) + '<\/code><\/td><td>' + (j.active ? '<span class="badge badge-success">Active<\/span>' : '<span class="badge badge-muted">Inactive<\/span>') + '<\/td><\/tr>';
});
}
html += '<\/tbody><\/table>';container.innerHTML = html;
}
window._cronToggle = function(checked) { showActiveOnly = checked; render(); };render();
} catch (e) {
container.innerHTML = '<div class="card-error"><p>' + escapeHtml(e.message || 'Failed to load cron jobs') + '<\/p><\/div>';
}
}
async function loadHttpLog(container) {
container.innerHTML = '<div style="padding:1rem"><div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><\/div>';try {
const { data, error } = await sb.rpc('get_cron_http_responses', { p_limit: 50 });if (error) throw error;const logs = data || [];let errorsOnly = false;function render() {
const filtered = errorsOnly ? logs.filter(l => l.status_code !== 200 || l.timed_out || l.error_msg) : logs;let html = '<div class="filter-bar"><label class="toggle-wrap"><input type="checkbox" ' + (errorsOnly ? 'checked' : '') + ' onchange="window._httpToggle(this.checked)"> Errors only<\/label><\/div>';html += '<table class="data-table"><thead><tr><th>ID<\/th><th>Status<\/th><th>Error<\/th><th>Time<\/th><\/tr><\/thead><tbody>';if (filtered.length === 0) {
html += '<tr><td colspan="4" style="text-align:center;color:var(--text-dim)">No entries<\/td><\/tr>';
} else {
filtered.forEach(l => {
const isErr = l.status_code !== 200 || l.timed_out || l.error_msg;const statusHtml = l.timed_out ? '<span class="badge badge-error">Timeout<\/span>' : l.status_code ? (l.status_code === 200 ? '<span class="badge badge-success">200<\/span>' : '<span class="badge badge-error">' + l.status_code + '<\/span>') : '<span class="badge badge-muted">—<\/span>';const errMsg = l.error_msg ? escapeHtml(l.error_msg.substring(0,80)) : '—';html += '<tr><td>' + l.id + '<\/td><td>' + statusHtml + '<\/td><td>' + errMsg + '<\/td><td style="white-space:nowrap">' + formatDate(l.created) + '<\/td><\/tr>';
});
}
html += '<\/tbody><\/table>';container.innerHTML = html;
}
window._httpToggle = function(checked) { errorsOnly = checked; render(); };render();
} catch (e) {
container.innerHTML = '<div class="card-error"><p>' + escapeHtml(e.message || 'Failed to load HTTP log') + '<\/p><\/div>';
}
}
async function loadAgentRegistry(container) {
container.innerHTML = '<div style="padding:1rem"><div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><\/div>';try {
const { data, error } = await sb.from('assistants').select('assistant_id, assistant_name, agent_type, brain, is_active, category, functional_domains, last_active_at').eq('is_active', true).order('assistant_name');if (error) throw error;const agents = data || [];const types = [...new Set(agents.map(a => a.agent_type).filter(Boolean))].sort();let searchText = '';let typeFilter = '';function render() {
let filtered = agents;if (searchText) {
const q = searchText.toLowerCase();filtered = filtered.filter(a => (a.assistant_name || '').toLowerCase().includes(q) || (a.assistant_id || '').toLowerCase().includes(q) || (a.category || '').toLowerCase().includes(q));
}
if (typeFilter) {
filtered = filtered.filter(a => a.agent_type === typeFilter);
}
let html = '<div class="filter-bar">';html += '<input type="text" placeholder="Search agents..." value="' + escapeHtml(searchText) + '" oninput="window._agentSearch(this.value)">';html += '<select onchange="window._agentTypeFilter(this.value)"><option value="">All types<\/option>';types.forEach(t => { html += '<option value="' + escapeHtml(t) + '"' + (typeFilter === t ? ' selected' : '') + '>' + escapeHtml(t) + '<\/option>'; });html += '<\/select>';html += '<span style="color:var(--text-muted);font-size:0.8rem">' + filtered.length + ' agents<\/span>';html += '<\/div>';html += '<table class="data-table"><thead><tr><th>Agent<\/th><th>Type<\/th><th>Brain<\/th><th>Category<\/th><\/tr><\/thead><tbody>';filtered.forEach(a => {
html += '<tr><td><strong>' + escapeHtml(a.assistant_name) + '<\/strong><br><span style="font-size:0.7rem;color:var(--text-dim)">' + escapeHtml(a.assistant_id) + '<\/span><\/td><td>' + statusBadge(a.agent_type) + '<\/td><td>' + (a.brain ? '<span class="badge badge-info">' + escapeHtml(a.brain) + '<\/span>' : '<span class="badge badge-muted">—<\/span>') + '<\/td><td>' + escapeHtml(a.category || '—') + '<\/td><\/tr>';
});html += '<\/tbody><\/table>';container.innerHTML = html;
}
window._agentSearch = function(val) { searchText = val; render(); };window._agentTypeFilter = function(val) { typeFilter = val; render(); };render();
} catch (e) {
container.innerHTML = '<div class="card-error"><p>' + escapeHtml(e.message || 'Failed to load agents') + '<\/p><\/div>';
}
}

</script>
</body>
</html>