<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowOps360 Command Center</title>
<style>:root{--bg:#0f172a;--bg-card:#1e293b;--bg-hover:#334155;--text:#f1f5f9;--text-muted:#94a3b8;--text-dim:#64748b;--accent:#3b82f6;--accent-hover:#2563eb;--success:#22c55e;--warning:#f59e0b;--error:#ef4444;--border:#334155;--radius:8px;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;}.login-box{background:var(--bg-card);padding:2rem;border-radius:8px;border:1px solid var(--border);width:360px;}.login-box h1{font-size:1.25rem;margin-bottom:0.25rem;}.login-box p{color:var(--text-muted);font-size:0.85rem;margin-bottom:1.5rem;}.login-box label{display:block;font-size:0.8rem;color:var(--text-muted);margin-bottom:0.25rem;}.login-box input{width:100%;padding:0.5rem 0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem;margin-bottom:1rem;}.login-box input:focus{outline:none;border-color:var(--accent);}.login-box button{width:100%;padding:0.6rem;background:var(--accent);color:white;border:none;border-radius:8px;font-size:0.9rem;cursor:pointer;}.login-box button:hover{background:var(--accent-hover);}.login-box button:disabled{opacity:0.5;cursor:not-allowed;}.login-error{color:var(--error);font-size:0.8rem;margin-bottom:0.75rem;display:none;}#dashboard{display:none;}.top-bar{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1.5rem;background:var(--bg-card);border-bottom:1px solid var(--border);}.top-bar h1{font-size:1rem;}.top-bar-right{display:flex;align-items:center;gap:1rem;}.top-bar-right span{font-size:0.8rem;color:var(--text-muted);}.btn-sm{padding:0.35rem 0.75rem;font-size:0.8rem;border:1px solid var(--border);background:transparent;color:var(--text-muted);border-radius:8px;cursor:pointer;}.btn-sm:hover{background:var(--bg-hover);color:var(--text);}.nav-tabs{display:flex;gap:0;padding:0 1.5rem;background:var(--bg-card);border-bottom:1px solid var(--border);overflow-x:auto;}.nav-tab{padding:0.6rem 1.25rem;font-size:0.85rem;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.15s;}.nav-tab:hover{color:var(--text);background:var(--bg-hover);}.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:1rem;padding:1.5rem;}.card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;overflow:hidden;}.card-header{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-bottom:1px solid var(--border);}.card-header h3{font-size:0.85rem;font-weight:600;}.card-header .card-count{font-size:0.75rem;color:var(--text-muted);background:var(--bg);padding:0.15rem 0.5rem;border-radius:10px;}.card-body{padding:1rem;min-height:80px;position:relative;}.shimmer{background:linear-gradient(90deg,var(--bg) 25%,var(--bg-hover) 50%,var(--bg) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px;height:14px;margin-bottom:0.5rem;}@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}.card-empty{text-align:center;color:var(--text-dim);padding:1.5rem;font-size:0.85rem;}.card-error{text-align:center;padding:1rem;}.card-error p{color:var(--error);font-size:0.85rem;margin-bottom:0.75rem;}.btn-retry{padding:0.35rem 1rem;background:transparent;border:1px solid var(--error);color:var(--error);border-radius:8px;cursor:pointer;font-size:0.8rem;}.btn-retry:hover{background:var(--error);color:white;}.data-table{width:100%;border-collapse:collapse;font-size:0.8rem;}.data-table th{text-align:left;padding:0.5rem 0.75rem;color:var(--text-muted);font-weight:500;border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;user-select:none;}.data-table th:hover{color:var(--text);}.data-table th .sort-icon{margin-left:4px;opacity:0.4;}.data-table th.sorted .sort-icon{opacity:1;}.data-table td{padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);vertical-align:top;}.data-table tr:hover td{background:var(--bg-hover);}.badge{display:inline-block;padding:0.1rem 0.5rem;border-radius:10px;font-size:0.7rem;font-weight:500;}.badge-success{background:rgba(34,197,94,0.15);color:var(--success);}.badge-warning{background:rgba(245,158,11,0.15);color:var(--warning);}.badge-error{background:rgba(239,68,68,0.15);color:var(--error);}.badge-info{background:rgba(59,130,246,0.15);color:var(--accent);}.badge-muted{background:rgba(148,163,184,0.1);color:var(--text-muted);}.kpi-row{display:flex;gap:1rem;flex-wrap:wrap;}.kpi-metric{flex:1;min-width:100px;text-align:center;padding:0.5rem;}.kpi-value{font-size:1.5rem;font-weight:700;}.kpi-label{font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem;}.filter-bar{display:flex;gap:0.5rem;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;}.filter-bar input,.filter-bar select{padding:0.35rem 0.6rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.8rem;}.toggle-wrap{display:flex;align-items:center;gap:0.35rem;font-size:0.8rem;color:var(--text-muted);}.toggle-wrap input[type=checkbox]{accent-color:var(--accent);}.pagination{display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;font-size:0.8rem;color:var(--text-muted);}.pagination button{padding:0.25rem 0.6rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;font-size:0.8rem;}.pagination button:disabled{opacity:0.3;cursor:not-allowed;}.sub-tabs{display:flex;gap:0;padding:0 1.5rem;background:var(--bg);border-bottom:1px solid var(--border);}.sub-tab{padding:0.5rem 1rem;font-size:0.8rem;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;}.sub-tab:hover{color:var(--text-muted);}.sub-tab.active{color:var(--accent);border-bottom-color:var(--accent);}.sub-content{padding:1.5rem;}.toast{position:fixed;bottom:1.5rem;right:1.5rem;padding:0.75rem 1.25rem;border-radius:8px;font-size:0.85rem;z-index:1000;}.toast-success{background:var(--success);color:white;}.toast-error{background:var(--error);color:white;}.truncate{max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.placeholder-pillar{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;color:var(--text-dim);}.placeholder-pillar h2{font-size:1.25rem;margin-bottom:0.5rem;}.placeholder-pillar p{font-size:0.85rem;}</style>
</head>
<body>
<div id="login-screen">
<div class="login-box">
<h1>FlowOps360 Command Center</h1>
<p>COO Brain Dashboard</p>
<div id="login-error" class="login-error"></div>
<label for="email">Email</label>
<input type="email" id="email" placeholder="you@example.com" autocomplete="email">
<label for="password">Password</label>
<input type="password" id="password" placeholder="Password" autocomplete="current-password">
<button id="login-btn" onclick="doLogin()">Sign In</button>
</div>
</div>
<div id="dashboard">
<div class="top-bar">
<h1>FlowOps360 Command Center</h1>
<div class="top-bar-right">
<span id="user-email"></span>
<button class="btn-sm" onclick="doLogout()">Sign Out</button>
</div>
</div>
<div class="nav-tabs" id="nav-tabs"></div>
<div id="pillar-content"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
function showToast(message, type) {
type=type||'success';const el = document.createElement('div');el.className = 'toast toast-' + type;el.textContent = message;document.body.appendChild(el);setTimeout(function(){el.remove()}, 3000);
}
function createCard(containerId, title, count) {
var card = document.createElement('div');card.className = 'card';card.id = 'card-' + containerId;var hdr = document.createElement('div');hdr.className = 'card-header';hdr.innerHTML = '<h3>' + escapeHtml(title) + '<\/h3><span class="card-count"><\/span>';var body = document.createElement('div');body.className = 'card-body';body.id = containerId;card.appendChild(hdr);card.appendChild(body);return card;
}
function cardLoading(id) {var el = document.getElementById(id);if(el)el.innerHTML = '<div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><div class="shimmer" style="width:70%"><\/div>';}
function cardSuccess(id, html) {var el = document.getElementById(id);if(el)el.innerHTML = html;}
function cardEmpty(id, msg) {var el = document.getElementById(id);if(el)el.innerHTML = '<div class="card-empty">' + escapeHtml(msg||'No data') + '<\/div>';}
function cardError(id, msg, fn) {var el = document.getElementById(id);if(!el)return;el.innerHTML = '<div class="card-error"><p>' + escapeHtml(msg) + '<\/p>' + (fn ? '<button class="btn-retry" onclick="' + fn + '()">Retry<\/button>' : '') + '<\/div>';}
function updateCardCount(id, c) {var card = document.getElementById('card-' + id);if(!card)return;var b = card.querySelector('.card-count');if(b)b.textContent = c;}
function escapeHtml(s) {if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/\x3c/g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function formatDate(d) {if(!d)return'—';var dt=new Date(d);if(isNaN(dt))return'—';return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function formatTime(d) {if(!d)return'—';var dt=new Date(d);if(isNaN(dt))return'—';return dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:'America/Phoenix'});}
function formatCurrency(n) {if(n==null)return'—';return'$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});}
function daysAgo(d) {if(!d)return null;return Math.floor((Date.now()-new Date(d).getTime())/86400000);}
function staleBadge(days) {if(days==null)return'';if(days>90)return'<span class="badge badge-error">'+days+'d<\/span>';if(days>30)return'<span class="badge badge-warning">'+days+'d<\/span>';if(days>14)return'<span class="badge badge-info">'+days+'d<\/span>';return'<span class="badge badge-muted">'+days+'d<\/span>';}
function statusBadge(s) {var m={now:'badge-error',in_review:'badge-warning',next:'badge-info','new':'badge-muted',waiting:'badge-warning',in_queue:'badge-info',pending:'badge-warning',healthy:'badge-success',critical:'badge-error',stale:'badge-warning',warning:'badge-warning'};return'<span class="badge '+(m[s]||'badge-muted')+'">'+escapeHtml(s||'—')+'<\/span>';}
function clientBadge(n) {if(!n)return'<span class="badge badge-muted">Unknown<\/span>';return'<span class="badge badge-info">'+escapeHtml(n)+'<\/span>';}
function linkIcon(url) {if(!url)return'';return'<a href="'+escapeHtml(url)+'" target="_blank" rel="noopener">↗<\/a>';}
function renderSortableTable(cid, cols, rows, opts) {
opts=opts||{};var ps=opts.pageSize||25,cp=0,sc=opts.defaultSort||null,sd=opts.defaultSortDir||'asc',ft='';
function render(){
var f=rows;if(ft){var q=ft.toLowerCase();f=rows.filter(function(r){return cols.some(function(c){return String(r[c.key]||'').toLowerCase().indexOf(q)>=0})})}
if(sc){f=f.slice().sort(function(a,b){var va=a[sc],vb=b[sc];if(va==null)va='';if(vb==null)vb='';if(typeof va==='number'&&typeof vb==='number')return sd==='asc'?va-vb:vb-va;return sd==='asc'?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va))})}
var tot=f.length,pgs=Math.ceil(tot/ps)||1;if(cp>=pgs)cp=pgs-1;var st=cp*ps,pr=f.slice(st,st+ps),h='';if(rows.length>10)h+='<div class="filter-bar"><input type="text" placeholder="Search..." value="'+escapeHtml(ft)+'" onkeyup="window._tf_'+cid+'(this.value)"><\/div>';h+='<table class="data-table"><thead><tr>';cols.forEach(function(c){var is=sc===c.key,ar=is?(sd==='asc'?' ▲':' ▼'):' ▴';h+='<th class="'+(is?'sorted':'')+'" onclick="window._ts_'+cid+'(''+c.key+'')">' +escapeHtml(c.label)+'<span class="sort-icon">'+ar+'<\/span><\/th>'});h+='<\/tr><\/thead><tbody>';if(!pr.length)h+='<tr><td colspan="'+cols.length+'" style="text-align:center;color:var(--text-dim);padding:1rem">No results<\/td><\/tr>';else pr.forEach(function(r){h+='<tr>';cols.forEach(function(c){h+='<td>'+(c.render?c.render(r):escapeHtml(r[c.key]))+'<\/td>'});h+='<\/tr>'});h+='<\/tbody><\/table>';if(tot>ps)h+='<div class="pagination"><span>'+(st+1)+'-'+Math.min(st+ps,tot)+' of '+tot+'<\/span><div><button '+(cp===0?'disabled':'')+' onclick="window._tp_'+cid+'('+(cp-1)+')">&lt;<\/button> <button '+(cp>=pgs-1?'disabled':'')+' onclick="window._tp_'+cid+'('+(cp+1)+')">&gt;<\/button><\/div><\/div>';cardSuccess(cid,h)}
window['_ts_'+cid]=function(c){if(sc===c)sd=sd==='asc'?'desc':'asc';else{sc=c;sd='asc'}render()};window['_tf_'+cid]=function(v){ft=v;cp=0;render()};window['_tp_'+cid]=function(p){cp=p;render()};render()}

</script>
<script>
var SB_URL='https://bbsldtgusmjpulohxzpa.supabase.co',SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJic2xkdGd1c21qcHVsb2h4enBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTAyNzQsImV4cCI6MjA4NTYyNjI3NH0.wnRJpsDrXn2dRqQQsGVzToAeauxZgboPiXPxRc-5Xq8',sb=supabase.createClient(SB_URL,SB_KEY),fails=0;
var PILLARS=[{id:'operations',label:'Operations',loader:loadOperations},{id:'sales',label:'Sales',loader:null},{id:'marketing',label:'Marketing',loader:null},{id:'leadership',label:'Leadership',loader:null},{id:'finance',label:'Finance',loader:null},{id:'legal',label:'Legal',loader:null},{id:'system',label:'System',loader:loadSystem}],active='operations';
async function doLogin(){var em=document.getElementById('email').value.trim(),pw=document.getElementById('password').value,err=document.getElementById('login-error'),btn=document.getElementById('login-btn');err.style.display='none';if(!em||!pw){err.textContent='Email and password required.';err.style.display='block';return}btn.disabled=true;btn.textContent='Signing in...';try{var r=await sb.auth.signInWithPassword({email:em,password:pw});if(r.error){fails++;err.textContent=r.error.message&&r.error.message.indexOf('Invalid login credentials')>=0?'Invalid email or password.':fails>=3?'Auth may not be configured. Contact admin.':r.error.message||'Login failed.';err.style.display='block';btn.disabled=false;btn.textContent='Sign In';return}showDash(r.data.user)}catch(e){err.textContent='Unable to connect.';err.style.display='block';btn.disabled=false;btn.textContent='Sign In'}}
async function doLogout(){await sb.auth.signOut();document.getElementById('dashboard').style.display='none';document.getElementById('login-screen').style.display='flex';document.getElementById('password').value='';document.getElementById('login-error').style.display='none'}
function showDash(u){document.getElementById('login-screen').style.display='none';document.getElementById('dashboard').style.display='block';document.getElementById('user-email').textContent=u.email;renderNav();navTo('operations')}
function renderNav(){var n=document.getElementById('nav-tabs');n.innerHTML='';PILLARS.forEach(function(p){var t=document.createElement('div');t.className='nav-tab'+(p.id===active?' active':'');t.textContent=p.label;t.onclick=function(){navTo(p.id)};n.appendChild(t)})}
function navTo(pid){active=pid;renderNav();var c=document.getElementById('pillar-content');c.innerHTML='';var p=PILLARS.find(function(x){return x.id===pid});if(p&&p.loader)p.loader(c);else c.innerHTML='<div class="placeholder-pillar"><h2>'+escapeHtml(p.label)+'<\/h2><p>Coming in Phase 2<\/p><\/div>'}
async function hErr(cid,rpc,e,fn){if(e&&(e.code==='PGRST301'||(e.message&&e.message.indexOf('JWT')>=0))){showToast('Session expired','error');await doLogout();return}console.error({card:cid,rpc:rpc,err:e&&e.message,ts:new Date().toISOString()});cardError(cid,e&&e.message||'Failed to load',fn)}
(async function(){var s=await sb.auth.getSession();if(s.data.session&&s.data.session.user)showDash(s.data.session.user);sb.auth.onAuthStateChange(function(ev){if(ev==='SIGNED_OUT'){document.getElementById('dashboard').style.display='none';document.getElementById('login-screen').style.display='flex'}})})();

</script>
<script>
function loadOperations(ct){var g=document.createElement('div');g.className='card-grid';[{id:'now-items',t:'Now Items',l:ldNow},{id:'todays-calendar',t:"Today's Calendar",l:ldCal},{id:'overdue-tickets',t:'Overdue Tickets',l:ldOver},{id:'retainer-billing',t:'Retainer Billing',l:ldBill},{id:'email-triage',t:'Email Triage',l:ldEmail},{id:'carry-forward',t:'Carry Forward',l:ldCarry},{id:'stale-waiting',t:'Stale / Waiting',l:ldStale},{id:'open-tickets',t:'Open Tickets',l:ldOpen},{id:'time-entry',t:'Time Entry',l:ldTime}].forEach(function(c){g.appendChild(createCard(c.id,c.t));c.l()});ct.appendChild(g)}
async function ldNow(){cardLoading('now-items');try{var r=await sb.rpc('get_standup_now_items');if(r.error){await hErr('now-items','get_standup_now_items',r.error,'ldNow');return}var d=r.data||[];if(!d.length){cardEmpty('now-items','No active now items');return}updateCardCount('now-items',d.length);var h='<table class="data-table"><thead><tr><th>Task<\/th><th>Client<\/th><th>Due<\/th><th><\/th><\/tr><\/thead><tbody>';d.forEach(function(i){h+='<tr><td>'+escapeHtml(i.title)+'<\/td><td>'+clientBadge(i.client_name)+'<\/td><td>'+formatDate(i.due_date)+'<\/td><td>'+linkIcon(i.hubspot_ticket_url)+'<\/td><\/tr>'});h+='<\/tbody><\/table>';cardSuccess('now-items',h)}catch(e){await hErr('now-items','get_standup_now_items',e,'ldNow')}}
async function ldCal(){cardLoading('todays-calendar');try{var r=await sb.rpc('get_standup_todays_calendar');if(r.error){await hErr('todays-calendar','get_standup_todays_calendar',r.error,'ldCal');return}var d=r.data||[];if(!d.length){cardEmpty('todays-calendar','No meetings today');return}updateCardCount('todays-calendar',d.length);var h='<table class="data-table"><thead><tr><th>Time<\/th><th>Meeting<\/th><th>Client<\/th><\/tr><\/thead><tbody>';d.forEach(function(i){h+='<tr><td style="white-space:nowrap">'+formatTime(i.start_time)+'<\/td><td>'+escapeHtml(i.subject)+'<\/td><td>'+clientBadge(i.client_name)+'<\/td><\/tr>'});h+='<\/tbody><\/table>';cardSuccess('todays-calendar',h)}catch(e){await hErr('todays-calendar','get_standup_todays_calendar',e,'ldCal')}}
async function ldOver(){cardLoading('overdue-tickets');try{var r=await sb.rpc('get_standup_overdue_tickets');if(r.error){await hErr('overdue-tickets','get_standup_overdue_tickets',r.error,'ldOver');return}var d=r.data;if(!d||!d.by_client||!d.by_client.length){cardEmpty('overdue-tickets','No overdue tickets');return}updateCardCount('overdue-tickets',d.total_overdue+' / '+d.total_open);var h='<div class="kpi-row"><div class="kpi-metric"><div class="kpi-value" style="color:var(--error)">'+d.total_overdue+'<\/div><div class="kpi-label">Overdue<\/div><\/div><div class="kpi-metric"><div class="kpi-value">'+d.total_open+'<\/div><div class="kpi-label">Total Open<\/div><\/div><\/div><table class="data-table" style="margin-top:0.75rem"><thead><tr><th>Client<\/th><th>Count<\/th><th>Sample<\/th><th><\/th><\/tr><\/thead><tbody>';d.by_client.forEach(function(c){var t=c.tickets&&c.tickets[0];h+='<tr><td>'+clientBadge(c.client_name)+'<\/td><td>'+(c.count||(c.tickets?c.tickets.length:0))+'<\/td><td class="truncate">'+escapeHtml(t?t.subject:'—')+'<\/td><td>'+linkIcon(t?t.hubspot_ticket_url:null)+'<\/td><\/tr>'});h+='<\/tbody><\/table>';cardSuccess('overdue-tickets',h)}catch(e){await hErr('overdue-tickets','get_standup_overdue_tickets',e,'ldOver')}}
async function ldBill(){cardLoading('retainer-billing');try{var r=await sb.rpc('get_standup_retainer_billing');if(r.error){await hErr('retainer-billing','get_standup_retainer_billing',r.error,'ldBill');return}var d=r.data;if(!d||!d.billing||!d.billing.length){cardEmpty('retainer-billing','No retainer data');return}var h='<table class="data-table"><thead><tr><th>Client<\/th><th>Amount<\/th><th>Status<\/th><th>Plan<\/th><th>Done<\/th><\/tr><\/thead><tbody>';d.billing.forEach(function(b){var cap=d.capped_status&&d.capped_status.find(function(c){return c.client_name===b.client_name});var sh=statusBadge(b.invoice_status);if(cap)sh+=' <span class="badge badge-warning">'+cap.hours_used+'/'+cap.included_hours_per_month+'h<\/span>';h+='<tr><td>'+clientBadge(b.client_name)+'<\/td><td>'+formatCurrency(b.retainer_amount)+'<\/td><td>'+sh+'<\/td><td>'+(b.total_items_planned||0)+'<\/td><td>'+(b.total_items_completed||0)+'<\/td><\/tr>'});h+='<\/tbody><\/table>';cardSuccess('retainer-billing',h)}catch(e){await hErr('retainer-billing','get_standup_retainer_billing',e,'ldBill')}}
async function ldEmail(){cardLoading('email-triage');try{var r=await sb.rpc('get_standup_email_digest');if(r.error){await hErr('email-triage','get_standup_email_digest',r.error,'ldEmail');return}var d=r.data;if(!d||!d.stats){cardEmpty('email-triage','No email data');return}var s=d.stats,h='<div class="kpi-row"><div class="kpi-metric"><div class="kpi-value">'+(s.total_processed||0)+'<\/div><div class="kpi-label">Processed<\/div><\/div><div class="kpi-metric"><div class="kpi-value">'+(s.auto_filed||0)+'<\/div><div class="kpi-label">Auto-Filed<\/div><\/div><div class="kpi-metric"><div class="kpi-value" style="color:'+(s.needs_action>0?'var(--warning)':'var(--success)')+'">'+(s.needs_action||0)+'<\/div><div class="kpi-label">Needs Action<\/div><\/div><div class="kpi-metric"><div class="kpi-value">'+(d.unprocessed||0)+'<\/div><div class="kpi-label">Unprocessed<\/div><\/div><\/div>';if(d.standup_queue&&d.standup_queue.length){h+='<table class="data-table" style="margin-top:0.75rem"><thead><tr><th>Subject<\/th><th>From<\/th><th>Type<\/th><\/tr><\/thead><tbody>';d.standup_queue.forEach(function(e){h+='<tr><td>'+escapeHtml(e.subject)+'<\/td><td>'+escapeHtml(e.sender_email||e.from)+'<\/td><td>'+statusBadge(e.email_type||e.type)+'<\/td><\/tr>'});h+='<\/tbody><\/table>'}cardSuccess('email-triage',h)}catch(e){await hErr('email-triage','get_standup_email_digest',e,'ldEmail')}}
async function ldCarry(){cardLoading('carry-forward');try{var r=await sb.rpc('get_standup_carry_forward');if(r.error){await hErr('carry-forward','get_standup_carry_forward',r.error,'ldCarry');return}var d=r.data||[];if(!d.length){cardEmpty('carry-forward','Nothing carried forward');return}updateCardCount('carry-forward',d.length);var h='<table class="data-table"><thead><tr><th>Item<\/th><th>Type<\/th><th>Priority<\/th><\/tr><\/thead><tbody>';d.forEach(function(i){h+='<tr><td>'+escapeHtml(i.title||i.detail)+'<\/td><td>'+statusBadge(i.note_type||i.type)+'<\/td><td>'+statusBadge(i.priority)+'<\/td><\/tr>'});h+='<\/tbody><\/table>';cardSuccess('carry-forward',h)}catch(e){await hErr('carry-forward','get_standup_carry_forward',e,'ldCarry')}}
async function ldStale(){cardLoading('stale-waiting');try{var r=await sb.rpc('get_standup_stale_waiting');if(r.error){await hErr('stale-waiting','get_standup_stale_waiting',r.error,'ldStale');return}var d=r.data||[];if(!d.length){cardEmpty('stale-waiting','Nothing stale or waiting');return}updateCardCount('stale-waiting',d.length);var h='<table class="data-table"><thead><tr><th>Item<\/th><th>Status<\/th><th>Age<\/th><\/tr><\/thead><tbody>';d.forEach(function(i){h+='<tr><td>'+escapeHtml(i.title||i.subject)+'<\/td><td>'+statusBadge(i.status||i.stage)+'<\/td><td>'+staleBadge(i.days_stale||daysAgo(i.last_modified))+'<\/td><\/tr>'});h+='<\/tbody><\/table>';cardSuccess('stale-waiting',h)}catch(e){await hErr('stale-waiting','get_standup_stale_waiting',e,'ldStale')}}
async function ldOpen(){cardLoading('open-tickets');try{var r=await sb.rpc('get_standup_open_tickets');if(r.error){await hErr('open-tickets','get_standup_open_tickets',r.error,'ldOpen');return}var d=r.data;if(!d||!d.tickets){cardEmpty('open-tickets','No open tickets');return}updateCardCount('open-tickets',d.total);var tix=d.tickets.length>500?d.tickets.slice(0,500):d.tickets;renderSortableTable('open-tickets',[{key:'subject',label:'Subject',render:function(r){return'<span class="truncate" style="display:inline-block">'+escapeHtml(r.subject)+'<\/span> '+linkIcon(r.url)}},{key:'client_name',label:'Client',render:function(r){return clientBadge(r.client_name)}},{key:'stage',label:'Stage',render:function(r){return statusBadge(r.stage)}},{key:'last_modified',label:'Modified',render:function(r){return formatDate(r.last_modified)}}],tix,{defaultSort:'last_modified',defaultSortDir:'desc'})}catch(e){await hErr('open-tickets','get_standup_open_tickets',e,'ldOpen')}}
function ldTime(){cardEmpty('time-entry','Time entry coming in next deploy')}

</script>
<script>
function loadSystem(ct){var sn=document.createElement('div');sn.className='sub-tabs';var tabs=[{id:'sys-cron',l:'Cron Jobs',fn:ldCron},{id:'sys-http',l:'HTTP Log',fn:ldHttp},{id:'sys-agents',l:'Agent Registry',fn:ldAgents},{id:'sys-brains',l:'Brains'},{id:'sys-config',l:'Configuration'}],cd=document.createElement('div');cd.className='sub-content';cd.id='sys-content';var ast='sys-cron';function rSub(){sn.innerHTML='';tabs.forEach(function(t){var tab=document.createElement('div');tab.className='sub-tab'+(t.id===ast?' active':'');tab.textContent=t.l;tab.onclick=function(){ast=t.id;rSub();cd.innerHTML='';if(t.fn)t.fn(cd);else cd.innerHTML='<div class="placeholder-pillar"><h2>'+escapeHtml(t.l)+'<\/h2><p>Coming in Phase 2<\/p><\/div>'};sn.appendChild(tab)})}rSub();ct.appendChild(sn);ct.appendChild(cd);ldCron(cd)}
async function ldCron(ct){ct.innerHTML='<div style="padding:1rem"><div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><\/div>';try{var r=await sb.rpc('get_cron_job_status');if(r.error)throw r.error;var jobs=r.data||[],ao=true;function render(){var f=ao?jobs.filter(function(j){return j.active}):jobs,h='<div class="filter-bar"><label class="toggle-wrap"><input type="checkbox" '+(ao?'checked':'')+' onchange="window._ct(this.checked)"> Active only<\/label><\/div><table class="data-table"><thead><tr><th>Job Name<\/th><th>Schedule<\/th><th>Active<\/th><\/tr><\/thead><tbody>';if(!f.length)h+='<tr><td colspan="3" style="text-align:center;color:var(--text-dim)">No jobs<\/td><\/tr>';else f.forEach(function(j){h+='<tr><td>'+escapeHtml(j.jobname)+'<\/td><td><code style="font-size:0.75rem;color:var(--text-muted)">'+escapeHtml(j.schedule)+'<\/code><\/td><td>'+(j.active?'<span class="badge badge-success">Active<\/span>':'<span class="badge badge-muted">Inactive<\/span>')+'<\/td><\/tr>'});h+='<\/tbody><\/table>';ct.innerHTML=h}window._ct=function(c){ao=c;render()};render()}catch(e){ct.innerHTML='<div class="card-error"><p>'+escapeHtml(e.message||'Failed')+'<\/p><\/div>'}}
async function ldHttp(ct){ct.innerHTML='<div style="padding:1rem"><div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><\/div>';try{var r=await sb.rpc('get_cron_http_responses',{p_limit:50});if(r.error)throw r.error;var logs=r.data||[],eo=false;function render(){var f=eo?logs.filter(function(l){return l.status_code!==200||l.timed_out||l.error_msg}):logs,h='<div class="filter-bar"><label class="toggle-wrap"><input type="checkbox" '+(eo?'checked':'')+' onchange="window._ht(this.checked)"> Errors only<\/label><\/div><table class="data-table"><thead><tr><th>ID<\/th><th>Status<\/th><th>Error<\/th><th>Time<\/th><\/tr><\/thead><tbody>';if(!f.length)h+='<tr><td colspan="4" style="text-align:center;color:var(--text-dim)">No entries<\/td><\/tr>';else f.forEach(function(l){var sh=l.timed_out?'<span class="badge badge-error">Timeout<\/span>':l.status_code?(l.status_code===200?'<span class="badge badge-success">200<\/span>':'<span class="badge badge-error">'+l.status_code+'<\/span>'):'<span class="badge badge-muted">—<\/span>';h+='<tr><td>'+l.id+'<\/td><td>'+sh+'<\/td><td>'+(l.error_msg?escapeHtml(l.error_msg.substring(0,80)):'—')+'<\/td><td style="white-space:nowrap">'+formatDate(l.created)+'<\/td><\/tr>'});h+='<\/tbody><\/table>';ct.innerHTML=h}window._ht=function(c){eo=c;render()};render()}catch(e){ct.innerHTML='<div class="card-error"><p>'+escapeHtml(e.message||'Failed')+'<\/p><\/div>'}}
async function ldAgents(ct){ct.innerHTML='<div style="padding:1rem"><div class="shimmer" style="width:80%"><\/div><div class="shimmer" style="width:60%"><\/div><\/div>';try{var r=await sb.from('assistants').select('assistant_id,assistant_name,agent_type,brain,is_active,category').eq('is_active',true).order('assistant_name');if(r.error)throw r.error;var ag=r.data||[],types=[],seen={};ag.forEach(function(a){if(a.agent_type&&!seen[a.agent_type]){seen[a.agent_type]=1;types.push(a.agent_type)}});types.sort();var st='',tf='';function render(){var f=ag;if(st){var q=st.toLowerCase();f=f.filter(function(a){return(a.assistant_name||'').toLowerCase().indexOf(q)>=0||(a.assistant_id||'').toLowerCase().indexOf(q)>=0||(a.category||'').toLowerCase().indexOf(q)>=0})}if(tf)f=f.filter(function(a){return a.agent_type===tf});var h='<div class="filter-bar"><input type="text" placeholder="Search..." value="'+escapeHtml(st)+'" oninput="window._as(this.value)"><select onchange="window._af(this.value)"><option value="">All types<\/option>';types.forEach(function(t){h+='<option value="'+escapeHtml(t)+'"'+(tf===t?' selected':'')+'>'+escapeHtml(t)+'<\/option>'});h+='<\/select><span style="color:var(--text-muted);font-size:0.8rem">'+f.length+' agents<\/span><\/div><table class="data-table"><thead><tr><th>Agent<\/th><th>Type<\/th><th>Brain<\/th><th>Category<\/th><\/tr><\/thead><tbody>';f.forEach(function(a){h+='<tr><td><strong>'+escapeHtml(a.assistant_name)+'<\/strong><br><span style="font-size:0.7rem;color:var(--text-dim)">'+escapeHtml(a.assistant_id)+'<\/span><\/td><td>'+statusBadge(a.agent_type)+'<\/td><td>'+(a.brain?'<span class="badge badge-info">'+escapeHtml(a.brain)+'<\/span>':'<span class="badge badge-muted">—<\/span>')+'<\/td><td>'+escapeHtml(a.category||'—')+'<\/td><\/tr>'});h+='<\/tbody><\/table>';ct.innerHTML=h}window._as=function(v){st=v;render()};window._af=function(v){tf=v;render()};render()}catch(e){ct.innerHTML='<div class="card-error"><p>'+escapeHtml(e.message||'Failed')+'<\/p><\/div>'}}

</script>
</body>
</html>